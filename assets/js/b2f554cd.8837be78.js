"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[5894],{6042:t=>{t.exports=JSON.parse('{"blogPosts":[{"id":"azure-container-instances-caddy-security","metadata":{"permalink":"/blog/azure-container-instances-caddy-security","editUrl":"https://github.com/authcrunch/authcrunch.github.io/edit/main/blog/2024-02-25-azure-container-instances-caddy-security/index.md","source":"@site/blog/2024-02-25-azure-container-instances-caddy-security/index.md","title":"Secure Deployment of Application with Azure Container Instances and Caddy","description":"This tutorial walks you through deploying applications protected by caddy security app,","date":"2024-02-25T00:00:00.000Z","formattedDate":"February 25, 2024","tags":[{"label":"blog","permalink":"/blog/tags/blog"}],"readingTime":3.165,"hasTruncateMarker":false,"authors":[{"name":"Paul Greenberg","title":"Maintainer","url":"https://github.com/greenpau","imageURL":"https://github.com/greenpau.png","key":"greenpau"}],"frontMatter":{"slug":"azure-container-instances-caddy-security","title":"Secure Deployment of Application with Azure Container Instances and Caddy","authors":["greenpau"],"tags":["blog"]},"unlisted":false,"nextItem":{"title":"Welcome","permalink":"/blog/welcome"}},"content":"This tutorial walks you through deploying applications protected by caddy security app,\\nhosted by Caddy web server via Azure Container Instances (ACI) service.\\n\\n\x3c!-- begin-markdown-toc --\x3e\\n## Table of Contents\\n\\n* [Azure Configuration](#azure-configuration)\\n  * [Add Azure File Share](#add-azure-file-share)\\n  * [Copy Files to Azure File Share](#copy-files-to-azure-file-share)\\n  * [Container Deployment](#container-deployment)\\n* [Accessing Container](#accessing-container)\\n* [Troubleshooting](#troubleshooting)\\n* [Conclusion](#conclusion)\\n\\n\x3c!-- end-markdown-toc --\x3e\\n\\n## Azure Configuration\\n\\nDefine environment variables. Change `app` to something else, e.g. `xyz`.\\n\\n```bash\\nexport ACI_RG_NAME=app-auth-rg-001\\nexport ACI_ST_ACCOUNT_NAME=appauthst001\\nexport ACI_LOCATION=eastus\\nexport ACI_ST_SHARE_NAME=appauthstsh001\\n```\\n\\nNext, create resource group:\\n\\n```bash\\naz group create --name \\"${ACI_RG_NAME}\\" --location eastus\\n```\\n\\n### Add Azure File Share\\n\\nReferences:\\n* https://learn.microsoft.com/en-us/azure/container-instances/container-instances-volume-azure-files\\n* Reference: https://learn.microsoft.com/en-us/cli/azure/provider?view=azure-cli-latest#az-provider-register\\n\\nRegister a provider using your subscription ID:\\n\\n```bash\\naz provider register -n Microsoft.Storage --subscription 91cd6b60-64b7-46e2-bffb-952352196549\\n```\\n\\nCreate a storage account:\\n\\n```bash\\naz storage account create --resource-group \\"${ACI_RG_NAME}\\" --name \\"${ACI_ST_ACCOUNT_NAME}\\" --location \\"${ACI_LOCATION}\\" --sku Standard_LRS\\n```\\n\\nReview the newly created account:\\n\\n```bash\\naz storage account list | jq -r \'.[]\\n```\\n\\nCreate a file share:\\n\\n```bash\\naz storage share create --name \\"${ACI_ST_SHARE_NAME}\\" --account-name \\"${ACI_ST_ACCOUNT_NAME}\\"\\n```\\n\\n\\n### Copy Files to Azure File Share\\n\\nNavigate to Resource Group, then browse to Storage Share associated with it.\\n\\n![image](https://github.com/authcrunch/authcrunch.github.io/assets/3826416/447d6cef-d50e-4c2b-85be-676970a2712a)\\n\\nNext, open the share, click \\"Browse\\" and add the following nested directories. The `app-auth-ci-001` is the name of the Caddy instance (ACI container).\\n\\n* `caddy`,\\n  - `app-auth-ci-001`\\n    * `config`\\n\\n![image](https://github.com/authcrunch/authcrunch.github.io/assets/3826416/ee9c2d02-e9a7-4790-a34b-7c959b5c1d8e)\\n\\nNext, browse to `caddy/app-auth-ci-001/config` and upload `Caddyfile` with the following content.\\n\\n![image](https://github.com/authcrunch/authcrunch.github.io/assets/3826416/a58883fc-3d13-40e9-aae0-1ed037f6cd0a)\\n\\n```\\n{\\n\\thttp_port 80\\n\\thttps_port 443\\n\\tadmin off\\n\\tdebug\\n\\n\\torder authenticate before respond\\n\\torder authorize before basicauth\\n\\n\\tsecurity {\\n\\t\\tlocal identity store localdb {\\n\\t\\t\\trealm local\\n\\t\\t\\tpath {env.LOCAL_DATA_PATH}caddy/app-auth-ci-001/userdb/users.json\\n\\t\\t\\tuser webadmin {\\n\\t\\t\\t\\tname Webmaster\\n\\t\\t\\t\\temail webadmin@localhost.localdomain\\n\\t\\t\\t\\t# echo -n \\"App@2f4cb79053be\\" | bcrypt-cli -c 10\\n\\t\\t\\t\\tpassword \\"$2a$10$JqJEf2pra4hIkw4CSDePoOfIoXVUFwSn6pJie6m02MUP7YGQVPQAi\\" overwrite\\n\\t\\t\\t\\troles \\"authp/admin\\" \\"authp/user\\"\\n\\t\\t\\t}\\n\\t\\t\\tuser jsmith {\\n\\t\\t\\t\\tname John Smith\\n\\t\\t\\t\\temail jsmith@localhost.localdomain\\n\\t\\t\\t\\t# password {env.USER_JSMITH_SECRET}\\n\\t\\t\\t\\tpassword \\"App@2f4cb79053be\\"\\n\\t\\t\\t\\troles \\"authp/admin\\" \\"authp/user\\"\\n\\t\\t\\t}\\n\\t\\t}\\n\\n\\t\\tauthentication portal myportal {\\n\\t\\t\\tcrypto default token lifetime 7200\\n\\t\\t\\tcrypto key sign-verify {env.JWT_SHARED_KEY}\\n\\t\\t\\tcookie domain app-auth-ci-001.eastus.azurecontainer.io\\n\\t\\t\\tui {\\n\\t\\t\\t\\tlinks {\\n\\t\\t\\t\\t\\t\\"My Identity\\" \\"/auth/whoami\\" icon \\"las la-user\\"\\n\\t\\t\\t\\t\\t\\"File Server\\" \\"/\\" icon \\"las la-cloud\\"\\n\\t\\t\\t\\t}\\n\\t\\t\\t}\\n\\t\\t\\ttransform user {\\n\\t\\t\\t\\tmatch origin local\\n\\t\\t\\t\\taction add role authp/user\\n\\t\\t\\t}\\n\\t\\t\\tenable identity store localdb\\n\\t\\t}\\n\\n\\t\\tauthorization policy file_server_policy {\\n\\t\\t\\tcrypto key sign-verify {env.JWT_SHARED_KEY}\\n\\t\\t\\tset auth url /auth/\\n\\t\\t\\tallow roles \\"authp/admin\\" \\"authp/user\\"\\n\\t\\t}\\n\\t}\\n}\\n\\n:80 {\\n\\tredir https://{host}{uri} 302\\n}\\n\\n:443 {\\n\\ttls internal {\\n\\t\\ton_demand\\n\\t}\\n\\n\\troute /version* {\\n\\t\\trespond \\"app 1.0\\"\\n\\t}\\n\\n\\troute /debug* {\\n\\t\\tauthorize with file_server_policy\\n\\t\\theader Content-Type text/html\\n\\t\\trespond <<EOF\\n\\t\\t<html>\\n\\t\\t<body>\\n\\t\\t<p>Host: <code>{http.request.host}</code></p>\\n\\t\\t<p>Time: <code>{time.now.common_log}</code></p>\\n\\t\\t<p>ID: <code>{http.auth.user.id}</code></p>\\n\\t\\t</body>\\n\\t\\t</html>\\n\\t\\tEOF 200\\n\\t}\\n\\n\\troute /auth* {\\n\\t\\tauthenticate with myportal\\n\\t}\\n\\n\\troute /* {\\n\\t\\tauthorize with file_server_policy\\n\\t\\tfile_server {\\n\\t\\t\\troot {env.LOCAL_DATA_PATH}\\n\\t\\t\\tbrowse\\n\\t\\t}\\n\\t}\\n}\\n```\\n\\n### Container Deployment\\n\\nGet Storage Account Key:\\n\\n```bash\\nACI_ST_ACCOUNT_KEY=$(az storage account keys list --resource-group \\"${ACI_RG_NAME}\\" --account-name \\"${ACI_ST_ACCOUNT_NAME}\\" --query \\"[0].value\\" --output tsv)\\necho $ACI_ST_ACCOUNT_KEY\\n```\\n\\nNext, deploy the container:\\n\\n```bash\\naz container create --resource-group \\"${ACI_RG_NAME}\\" \\\\\\n  --name \\"app-auth-ci-001\\" \\\\\\n  --image \\"ghcr.io/authcrunch/authcrunch:latest\\" \\\\\\n  --dns-name-label \\"app-auth-ci-001\\" \\\\\\n  --ports 80 443 \\\\\\n  --azure-file-volume-account-name \\"${ACI_ST_ACCOUNT_NAME}\\" \\\\\\n  --azure-file-volume-account-key \\"${ACI_ST_ACCOUNT_KEY}\\" \\\\\\n  --azure-file-volume-share-name \\"${ACI_ST_SHARE_NAME}\\" \\\\\\n  --environment-variables LOCAL_DATA_PATH=\\"/app/data/\\" JWT_SHARED_KEY=\\"d24ae7de-ca54-4334-94ba-301fc414d5de\\" XDG_DATA_HOME=\\"/app/data/caddy/app-auth-ci-001/data\\" XDG_CONFIG_HOME=\\"/app/data/caddy/app-auth-ci-001/config\\" \\\\\\n  --azure-file-volume-mount-path /app/data/ \\\\\\n  --command-line \\"caddy run --config /app/data/caddy/app-auth-ci-001/config/Caddyfile\\"\\n```\\n\\n## Accessing Container\\n\\nBrowse to container URL: `https://app-auth-ci-001.eastus.azurecontainer.io/`\\n\\nThe first time your access your container, you get that the site is unreachable.\\n\\n![image](https://github.com/authcrunch/authcrunch.github.io/assets/3826416/b243c468-9399-4676-a848-be961c6e5d2f)\\n\\nIf you refresh after 10-15 seconds, you will get the connection is not private. It is expected. Trust the cert and proceed\\n\\n![image](https://github.com/authcrunch/authcrunch.github.io/assets/3826416/2a0337f9-8090-4712-a6f0-dd8b7b920888)\\n\\nAfter that, log in with username `jsmith` and password `App@2f4cb79053be`.\\n\\n![image](https://github.com/authcrunch/authcrunch.github.io/assets/3826416/a7b70a8b-fc4c-4c90-90c3-0bccd751c0e1)\\n\\nClick \\"File Server\\" to get redirected to Caddy file server browser:\\n\\n![image](https://github.com/authcrunch/authcrunch.github.io/assets/3826416/c525674d-c54d-457f-a5d6-bef5c96f9d99)\\n\\nYou should be able to browse the contents of `/app/data` directory.\\n\\n![image](https://github.com/authcrunch/authcrunch.github.io/assets/3826416/b9cf61c7-ca34-419e-a058-0c619339b9aa)\\n\\n## Troubleshooting\\n\\nList containers:\\n\\n```bash\\naz container list --resource-group \\"${ACI_RG_NAME}\\"\\n```\\n\\nCheck logs:\\n\\n```bash\\naz container logs --resource-group \\"${ACI_RG_NAME}\\" --name \\"app-auth-ci-001\\"\\naz container show --resource-group \\"${ACI_RG_NAME}\\" --name \\"app-auth-ci-001\\"\\n```\\n\\n## Conclusion\\n\\nThere are some gaps in my explanation. Please engage, ask questions [here](https://github.com/authcrunch/authcrunch.github.io/issues) \\nor submit edits [here](https://github.com/authcrunch/authcrunch.github.io/edit/main/blog/2024-02-25-azure-container-instances-caddy-security/index.md)."},{"id":"welcome","metadata":{"permalink":"/blog/welcome","editUrl":"https://github.com/authcrunch/authcrunch.github.io/edit/main/blog/2021-10-31-welcome/index.md","source":"@site/blog/2021-10-31-welcome/index.md","title":"Welcome","description":"Please share your stories about Caddy and auth plugins!","date":"2021-10-31T00:00:00.000Z","formattedDate":"October 31, 2021","tags":[{"label":"blog","permalink":"/blog/tags/blog"}],"readingTime":0.415,"hasTruncateMarker":false,"authors":[{"name":"Paul Greenberg","title":"Maintainer","url":"https://github.com/greenpau","imageURL":"https://github.com/greenpau.png","key":"greenpau"}],"frontMatter":{"slug":"welcome","title":"Welcome","authors":["greenpau"],"tags":["blog"]},"unlisted":false,"prevItem":{"title":"Secure Deployment of Application with Azure Container Instances and Caddy","permalink":"/blog/azure-container-instances-caddy-security"}},"content":"Please share your stories about Caddy and auth plugins!\\n\\nSimply add Markdown files (or folders) to the\\n[`blog/`](https://github.com/authcrunch/authcrunch.github.io/new/main/blog/)\\ndirectory.\\n\\nAdditionally, add yourself to blog authors via\\n[`authors.yml`](https://github.com/authcrunch/authcrunch.github.io/edit/main/blog/authors.yml).\\n\\nIf your blog post has images, then create a folder for the post\\nand co-locate images with the post itself.\\n\\n- `2021-10-31-mypost/index.md`\\n- `2021-10-31-mypost/image1.jpeg`\\n\\nInclude the image in the `.md` file with the following snippet:\\n\\n```\\n![Image for my post](./image1.jpeg)\\n```\\n\\nThe blog post date can be extracted from filenames, such as:\\n\\n- `2021-10-31-welcome.md`\\n- `2021-10-31-welcome/index.md`"}]}')}}]);